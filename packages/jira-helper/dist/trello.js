"use strict";
// tslint:disable no-console
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const jsYaml = tslib_1.__importStar(require("js-yaml"));
const puppeteer_1 = require("./puppeteer");
const axios_1 = tslib_1.__importDefault(require("axios"));
const log = require('log4js').getLogger('jira-helper');
const API_TOKEN = '38cfe637eacbbcf7bbd90b9ee83f31113d04b4d34fd79f13a5fe51608ba88028';
const API_KEY = '1846faaab21515d5bab05dec2fbda8bc';
function listTrello() {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const browser = yield puppeteer_1.launch(false);
        const pages = yield browser.pages();
        // const page = await browser.newPage();
        console.time('get page');
        // tslint:disable-next-line: max-line-length
        const url = 'https://trello.com/b/i6yaHbFX';
        log.info('GET ' + url);
        yield pages[0].goto(url, { timeout: 0, waitUntil: 'networkidle2' });
        console.log('fetching trello done');
        console.timeEnd('get page');
        const columns = yield listColumn(pages[0]);
        console.log(jsYaml.safeDump(columns));
        yield browser.close();
        console.log('Have a nice day');
    });
}
exports.listTrello = listTrello;
function listColumn(page) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        yield page.waitFor('#board', { visible: true });
        const columns = yield page.$$('#board > .list-wrapper > .list');
        return rxjs_1.of(...columns).pipe(operators_1.mergeMap(columnEl => {
            return rxjs_1.forkJoin(rxjs_1.from(columnEl.$('.list-header h2')).pipe(operators_1.mergeMap(bdTitle => rxjs_1.from(bdTitle.getProperty('innerText'))), operators_1.mergeMap(value => rxjs_1.from(value.jsonValue()))), rxjs_1.from(columnEl.$$('.list-card .list-card-title')).pipe(operators_1.mergeMap(cards => rxjs_1.from(cards)), operators_1.mergeMap(card => {
                return rxjs_1.forkJoin(rxjs_1.from(card.$('.card-short-id')).pipe(operators_1.mergeMap(id => id.getProperty('innerText')), operators_1.mergeMap(jh => rxjs_1.from(jh.jsonValue()))), rxjs_1.from(card.getProperty('innerText')).pipe(operators_1.mergeMap(jh => rxjs_1.from(jh.jsonValue()))));
            }), operators_1.map(([shortId, title]) => ({ title, shortId })), operators_1.reduce((cards, card) => {
                cards.push(card);
                return cards;
            }, [])));
        }), operators_1.map(([name, cards]) => {
            // log.info(` [ ${name} ] `);
            // log.info(cards.map(card => `  - ${card.shortId}: ${card.title}`).join('\n'));
            return { name, cards };
        }), operators_1.reduce((columns, bd) => {
            columns.push(bd);
            return columns;
        }, [])).toPromise();
    });
}
function syncFromJira(page, issues) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const columns = yield page.$$('#board > .list-wrapper > .list');
        const colNames = yield Promise.all(columns.map((col) => tslib_1.__awaiter(this, void 0, void 0, function* () {
            return (yield (yield col.$('.list-header h2')).getProperty('innerText')).jsonValue();
        })));
        const colNameSet = new Set(colNames.map(name => /^([\S]+)/.exec(name)[1])); // get space separated prefix
        console.log('existing column for projects:\n', Array.from(colNameSet.values()).join('\n'));
        for (const issue of issues) {
            const colName = issue.id.slice(0, issue.id.indexOf('-'));
            if (!colNameSet.has(colName)) {
                yield createColumn(page, colName);
            }
        }
    });
}
function test() {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const browser = yield puppeteer_1.launch(false);
        const page = (yield browser.pages())[0];
        yield page.goto(
        // tslint:disable-next-line: max-line-length
        'https://trello.com/b/i6yaHbFX', { waitUntil: 'networkidle2', timeout: 120000 });
        // await createColumn(page);
        yield syncFromJira(page, [{
                id: 'BCL-TEST',
                name: 'test issue',
                status: '',
                ver: ['abc'],
                assignee: 'superman'
            }]);
    });
}
exports.test = test;
function createColumn(page, name) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const column = yield page.$('#board > .js-add-list');
        if (column == null)
            throw new Error('Add column button is not found');
        yield page.waitForSelector('#board > .js-add-list a.open-add-list', { visible: true });
        yield (yield column.$('a.open-add-list')).click();
        yield page.waitFor(400);
        yield (yield column.$('input[type=text]')).type(name, { delay: 150 });
        const button = yield column.$('input.js-save-edit');
        yield button.click();
        yield puppeteer_1.waitForVisible(button, false);
        console.log('Column %s added', name);
    });
}
function apiTest() {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const res = yield axios_1.default.get('https://api.trello.com/1/members/me/boards', {
            params: {
                key: API_KEY,
                token: API_TOKEN
            }
        });
        console.log(res.data);
    });
}
exports.apiTest = apiTest;
function apiGetList(boardId = '5acdbf6678087812e8838ec4') {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const res = yield axios_1.default.get(`https://api.trello.com/1/boards/${boardId}/lists`, { params: {
                key: API_KEY,
                token: API_TOKEN
            } });
        const list = res.data;
        const obs = list
            .map(list => rxjs_1.from(axios_1.default.get(`https://api.trello.com/1/lists/${list.id}/cards`)));
        yield rxjs_1.forkJoin(...obs).pipe(operators_1.map(responses => {
            for (let i = 0, l = responses.length; i < l; i++) {
                // console.log(responses[i].data);
                // res.data[i].cards = responses[i].data;
                log.info('%s Number of cards', list[i].name, l);
            }
            console.log(responses[0].data[0]);
        })).toPromise();
    });
}
exports.apiGetList = apiGetList;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9AZHIvamlyYS1oZWxwZXIvdHMvdHJlbGxvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0QkFBNEI7OztBQUU1QiwrQkFBb0Q7QUFHcEQsOENBQXFEO0FBQ3JELHdEQUFrQztBQUNsQywyQ0FBbUQ7QUFFbkQsMERBQTJDO0FBRTNDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFdkQsTUFBTSxTQUFTLEdBQUcsa0VBQWtFLENBQUM7QUFDckYsTUFBTSxPQUFPLEdBQUcsa0NBQWtDLENBQUM7QUFxQm5ELFNBQXNCLFVBQVU7O1FBQzlCLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVwQyxNQUFNLEtBQUssR0FBRyxNQUFNLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNwQyx3Q0FBd0M7UUFDeEMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN6Qiw0Q0FBNEM7UUFDNUMsTUFBTSxHQUFHLEdBQUcsK0JBQStCLENBQUM7UUFDNUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFFdkIsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBQyxDQUFDLENBQUM7UUFDbEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1FBQ3BDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDNUIsTUFBTSxPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxD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QUFHLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDaEQsa0NBQWtDO2dCQUNsQyx5Q0FBeUM7Z0JBQ3pDLEdBQUcsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNqRDtZQUNELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUNILENBQUMsU0FBUyxFQUFFLENBQUM7SUFDaEIsQ0FBQztDQUFBO0FBbkJELGdDQW1CQyIsImZpbGUiOiJub2RlX21vZHVsZXMvQGRyL2ppcmEtaGVscGVyL2Rpc3QvdHJlbGxvLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdHNsaW50OmRpc2FibGUgbm8tY29uc29sZVxuXG5pbXBvcnQge2Zyb20sIG9mLCBmb3JrSm9pbiwgT2JzZXJ2YWJsZX0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1BhZ2V9IGZyb20gJ3B1cHBldGVlci1jb3JlJztcbmltcG9ydCAqIGFzIHRyIGZyb20gJy4vdHJlbGxvJztcbmltcG9ydCB7bWVyZ2VNYXAsIG1hcCwgcmVkdWNlfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgKiBhcyBqc1lhbWwgZnJvbSAnanMteWFtbCc7XG5pbXBvcnQge2xhdW5jaCwgd2FpdEZvclZpc2libGV9IGZyb20gJy4vcHVwcGV0ZWVyJztcbmltcG9ydCB7SXNzdWV9IGZyb20gJy4vamlyYSc7XG5pbXBvcnQgYXhpb3MsIHtBeGlvc1Jlc3BvbnNlfSBmcm9tICdheGlvcyc7XG5cbmNvbnN0IGxvZyA9IHJlcXVpcmUoJ2xvZzRqcycpLmdldExvZ2dlcignamlyYS1oZWxwZXInKTtcblxuY29uc3QgQVBJX1RPS0VOID0gJzM4Y2ZlNjM3ZWFjYmJjZjdiYmQ5MGI5ZWU4M2YzMTExM2QwNGI0ZDM0ZmQ3OWYxM2E1ZmU1MTYwOGJhODgwMjgnO1xuY29uc3QgQVBJX0tFWSA9ICcxODQ2ZmFhYWIyMTUxNWQ1YmFiMDVkZWMyZmJkYThiYyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJlbGxvQ29sdW1uIHtcbiAgbmFtZTogc3RyaW5nO1xuICBpZD86IHN0cmluZztcbiAgY2FyZHM6IFRyZWxsb0NhcmRbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUcmVsbG9DYXJkIHtcbiAgdGl0bGU6IHN0cmluZztcbiAgc2hvcnRJZDogc3RyaW5nO1xuICBpZD86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFRyZWxsb0FwaUNhcmQge1xuICBpZDogc3RyaW5nO1xuICBuYW1lOiBzdHJpbmc7XG4gIGJhZGdlcz86IGFueVtdO1xuICBsYWJlbHM/OiBhbnlbXTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxpc3RUcmVsbG8oKSB7XG4gIGNvbnN0IGJyb3dzZXIgPSBhd2FpdCBsYXVuY2goZmFsc2UpO1xuXG4gIGNvbnN0IHBhZ2VzID0gYXdhaXQgYnJvd3Nlci5wYWdlcygpO1xuICAvLyBjb25zdCBwYWdlID0gYXdhaXQgYnJvd3Nlci5uZXdQYWdlKCk7XG4gIGNvbnNvbGUudGltZSgnZ2V0IHBhZ2UnKTtcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcbiAgY29uc3QgdXJsID0gJ2h0dHBzOi8vdHJlbGxvLmNvbS9iL2k2eWFIYkZYJztcbiAgbG9nLmluZm8oJ0dFVCAnICsgdXJsKTtcblxuICBhd2FpdCBwYWdlc1swXS5nb3RvKHVybCwge3RpbWVvdXQ6IDAsIHdhaXRVbnRpbDogJ25ldHdvcmtpZGxlMid9KTtcbiAgY29uc29sZS5sb2coJ2ZldGNoaW5nIHRyZWxsbyBkb25lJyk7XG4gIGNvbnNvbGUudGltZUVuZCgnZ2V0IHBhZ2UnKTtcbiAgY29uc3QgY29sdW1ucyA9IGF3YWl0IGxpc3RDb2x1bW4ocGFnZXNbMF0pO1xuICBjb25zb2xlLmxvZyhqc1lhbWwuc2FmZUR1bXAoY29sdW1ucykpO1xuICBhd2FpdCBicm93c2VyLmNsb3NlKCk7XG4gIGNvbnNvbGUubG9nKCdIYXZlIGEgbmljZSBkYXknKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbGlzdENvbHVtbihwYWdlOiBQYWdlKTogUHJvbWlzZTx0ci5UcmVsbG9Db2x1bW5bXT4ge1xuICBhd2FpdCBwYWdlLndhaXRGb3IoJyNib2FyZCcsIHt2aXNpYmxlOiB0cnVlfSk7XG4gIGNvbnN0IGNvbHVtbnMgPSBhd2FpdCBwYWdlLiQkKCcjYm9hcmQgPiAubGlzdC13cmFwcGVyID4gLmxpc3QnKTtcblxuICByZXR1cm4gb2YoLi4uY29sdW1ucykucGlwZShcbiAgICBtZXJnZU1hcChjb2x1bW5FbCA9PiB7XG4gICAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICAgIGZyb20oY29sdW1uRWwuJCgnLmxpc3QtaGVhZGVyIGgyJykpLnBpcGUoXG4gICAgICAgICAgbWVyZ2VNYXAoYmRUaXRsZSA9PiBmcm9tKGJkVGl0bGUhLmdldFByb3BlcnR5KCdpbm5lclRleHQnKSkpLFxuICAgICAgICAgIG1lcmdlTWFwKHZhbHVlID0+IGZyb20odmFsdWUuanNvblZhbHVlKCkgYXMgUHJvbWlzZTxzdHJpbmc+KSlcbiAgICAgICAgKSxcbiAgICAgICAgZnJvbShjb2x1bW5FbC4kJCgnLmxpc3QtY2FyZCAubGlzdC1jYXJkLXRpdGxlJykpLnBpcGUoXG4gICAgICAgICAgbWVyZ2VNYXAoY2FyZHMgPT4gZnJvbShjYXJkcykpLFxuICAgICAgICAgIG1lcmdlTWFwKGNhcmQgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgICAgICAgICBmcm9tKGNhcmQuJCgnLmNhcmQtc2hvcnQtaWQnKSkucGlwZShcbiAgICAgICAgICAgICAgICBtZXJnZU1hcChpZCA9PiBpZCEuZ2V0UHJvcGVydHkoJ2lubmVyVGV4dCcpKSxcbiAgICAgICAgICAgICAgICBtZXJnZU1hcChqaCA9PiBmcm9tKGpoLmpzb25WYWx1ZSgpKSBhcyBPYnNlcnZhYmxlPHN0cmluZz4pXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIGZyb20oY2FyZC5nZXRQcm9wZXJ0eSgnaW5uZXJUZXh0JykpLnBpcGUoXG4gICAgICAgICAgICAgICAgbWVyZ2VNYXAoamggPT4gZnJvbShqaC5qc29uVmFsdWUoKSkgYXMgT2JzZXJ2YWJsZTxzdHJpbmc+KVxuICAgICAgICAgICAgICApKTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBtYXAoKFtzaG9ydElkLCB0aXRsZV0pID0+ICh7dGl0bGUsIHNob3J0SWR9IGFzIHRyLlRyZWxsb0NhcmQpKSxcbiAgICAgICAgICByZWR1Y2U8dHIuVHJlbGxvQ2FyZD4oKGNhcmRzLCBjYXJkKT0+IHtcbiAgICAgICAgICAgIGNhcmRzLnB1c2goY2FyZCk7XG4gICAgICAgICAgICByZXR1cm4gY2FyZHM7XG4gICAgICAgICAgfSwgW10pXG4gICAgICAgIClcbiAgICAgICk7XG4gICAgfSksXG4gICAgbWFwKChbbmFtZSwgY2FyZHNdKSA9PiB7XG4gICAgICAvLyBsb2cuaW5mbyhgIFsgJHtuYW1lfSBdIGApO1xuICAgICAgLy8gbG9nLmluZm8oY2FyZHMubWFwKGNhcmQgPT4gYCAgLSAke2NhcmQuc2hvcnRJZH06ICR7Y2FyZC50aXRsZX1gKS5qb2luKCdcXG4nKSk7XG4gICAgICByZXR1cm4ge25hbWUsIGNhcmRzfSBhcyB0ci5UcmVsbG9Db2x1bW47XG4gICAgfSksXG4gICAgcmVkdWNlPHRyLlRyZWxsb0NvbHVtbj4oKGNvbHVtbnMsIGJkKSA9PiB7XG4gICAgICBjb2x1bW5zLnB1c2goYmQpO1xuICAgICAgcmV0dXJuIGNvbHVtbnM7XG4gICAgfSwgW10pXG4gICkudG9Qcm9taXNlKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN5bmNGcm9tSmlyYShwYWdlOiBQYWdlLCBpc3N1ZXM6IElzc3VlW10pIHtcbiAgY29uc3QgY29sdW1ucyA9IGF3YWl0IHBhZ2UuJCQoJyNib2FyZCA+IC5saXN0LXdyYXBwZXIgPiAubGlzdCcpO1xuICBjb25zdCBjb2xOYW1lczogc3RyaW5nW10gPSBhd2FpdCBQcm9taXNlLmFsbChjb2x1bW5zLm1hcChhc3luYyBjb2wgPT4gKGF3YWl0XG4gICAgKGF3YWl0IGNvbC4kKCcubGlzdC1oZWFkZXIgaDInKSkhLmdldFByb3BlcnR5KCdpbm5lclRleHQnKVxuICAgICkuanNvblZhbHVlKClcbiAgKSk7XG5cbiAgY29uc3QgY29sTmFtZVNldCA9IG5ldyBTZXQoY29sTmFtZXMubWFwKG5hbWUgPT4gL14oW1xcU10rKS8uZXhlYyhuYW1lKSFbMV0pKTsgLy8gZ2V0IHNwYWNlIHNlcGFyYXRlZCBwcmVmaXhcbiAgY29uc29sZS5sb2coJ2V4aXN0aW5nIGNvbHVtbiBmb3IgcHJvamVjdHM6XFxuJywgQXJyYXkuZnJvbShjb2xOYW1lU2V0LnZhbHVlcygpKS5qb2luKCdcXG4nKSk7XG5cbiAgZm9yIChjb25zdCBpc3N1ZSBvZiBpc3N1ZXMpIHtcbiAgICBjb25zdCBjb2xOYW1lID0gaXNzdWUuaWQuc2xpY2UoMCwgaXNzdWUuaWQuaW5kZXhPZignLScpKTtcbiAgICBpZiAoIWNvbE5hbWVTZXQuaGFzKGNvbE5hbWUpKSB7XG4gICAgICBhd2FpdCBjcmVhdGVDb2x1bW4ocGFnZSwgY29sTmFtZSk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB0ZXN0KCkge1xuICBjb25zdCBicm93c2VyID0gYXdhaXQgbGF1bmNoKGZhbHNlKTtcbiAgY29uc3QgcGFnZSA9IChhd2FpdCBicm93c2VyLnBhZ2VzKCkpWzBdO1xuICBhd2FpdCBwYWdlLmdvdG8oXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcbiAgICAnaHR0cHM6Ly90cmVsbG8uY29tL2IvaTZ5YUhiRlgnLFxuICAgIHt3YWl0VW50aWw6ICduZXR3b3JraWRsZTInLCB0aW1lb3V0OiAxMjAwMDB9KTtcbiAgLy8gYXdhaXQgY3JlYXRlQ29sdW1uKHBhZ2UpO1xuICBhd2FpdCBzeW5jRnJvbUppcmEocGFnZSwgW3tcbiAgICBpZDogJ0JDTC1URVNUJyxcbiAgICBuYW1lOiAndGVzdCBpc3N1ZScsXG4gICAgc3RhdHVzOiAnJyxcbiAgICB2ZXI6IFsnYWJjJ10sXG4gICAgYXNzaWduZWU6ICdzdXBlcm1hbidcbiAgfV0pO1xufVxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQ29sdW1uKHBhZ2U6IFBhZ2UsIG5hbWU6IHN0cmluZykge1xuICBjb25zdCBjb2x1bW4gPSBhd2FpdCBwYWdlLiQoJyNib2FyZCA+IC5qcy1hZGQtbGlzdCcpO1xuICBpZiAoY29sdW1uID09IG51bGwpXG4gICAgdGhyb3cgbmV3IEVycm9yKCdBZGQgY29sdW1uIGJ1dHRvbiBpcyBub3QgZm91bmQnKTtcbiAgYXdhaXQgcGFnZS53YWl0Rm9yU2VsZWN0b3IoJyNib2FyZCA+IC5qcy1hZGQtbGlzdCBhLm9wZW4tYWRkLWxpc3QnLCB7dmlzaWJsZTogdHJ1ZX0pO1xuICBhd2FpdCAoYXdhaXQgY29sdW1uLiQoJ2Eub3Blbi1hZGQtbGlzdCcpKSEuY2xpY2soKTtcbiAgYXdhaXQgcGFnZS53YWl0Rm9yKDQwMCk7XG4gIGF3YWl0IChhd2FpdCBjb2x1bW4uJCgnaW5wdXRbdHlwZT10ZXh0XScpKSEudHlwZShuYW1lLCB7ZGVsYXk6IDE1MH0pO1xuICBjb25zdCBidXR0b24gPSBhd2FpdCBjb2x1bW4uJCgnaW5wdXQuanMtc2F2ZS1lZGl0Jyk7XG4gIGF3YWl0IGJ1dHRvbiEuY2xpY2soKTtcbiAgYXdhaXQgd2FpdEZvclZpc2libGUoYnV0dG9uISwgZmFsc2UpO1xuICBjb25zb2xlLmxvZygnQ29sdW1uICVzIGFkZGVkJywgbmFtZSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhcGlUZXN0KCkge1xuICBjb25zdCByZXMgPSBhd2FpdCBheGlvcy5nZXQoJ2h0dHBzOi8vYXBpLnRyZWxsby5jb20vMS9tZW1iZXJzL21lL2JvYXJkcycsIHtcbiAgICBwYXJhbXM6IHtcbiAgICAgIGtleTogQVBJX0tFWSxcbiAgICAgIHRva2VuOiBBUElfVE9LRU5cbiAgICB9fSk7XG4gIGNvbnNvbGUubG9nKHJlcy5kYXRhKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFwaUdldExpc3QoYm9hcmRJZCA9ICc1YWNkYmY2Njc4MDg3ODEyZTg4MzhlYzQnKSB7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IGF4aW9zLmdldDxUcmVsbG9Db2x1bW5bXT4oYGh0dHBzOi8vYXBpLnRyZWxsby5jb20vMS9ib2FyZHMvJHtib2FyZElkfS9saXN0c2AsIHtwYXJhbXM6IHtcbiAgICBrZXk6IEFQSV9LRVksXG4gICAgdG9rZW46IEFQSV9UT0tFTlxuICB9fSk7XG4gIGNvbnN0IGxpc3QgPSByZXMuZGF0YTtcbiAgY29uc3Qgb2JzID0gbGlzdFxuICAubWFwKGxpc3QgPT4gZnJvbShheGlvcy5nZXQ8VHJlbGxvQXBpQ2FyZFtdPihgaHR0cHM6Ly9hcGkudHJlbGxvLmNvbS8xL2xpc3RzLyR7bGlzdC5pZH0vY2FyZHNgKSkpO1xuXG4gIGF3YWl0IGZvcmtKb2luPEF4aW9zUmVzcG9uc2U8VHJlbGxvQXBpQ2FyZFtdPj4oLi4ub2JzKS5waXBlKFxuICAgIG1hcChyZXNwb25zZXMgPT4ge1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZXNwb25zZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHJlc3BvbnNlc1tpXS5kYXRhKTtcbiAgICAgICAgLy8gcmVzLmRhdGFbaV0uY2FyZHMgPSByZXNwb25zZXNbaV0uZGF0YTtcbiAgICAgICAgbG9nLmluZm8oJyVzIE51bWJlciBvZiBjYXJkcycsIGxpc3RbaV0ubmFtZSwgbCk7XG4gICAgICB9XG4gICAgICBjb25zb2xlLmxvZyhyZXNwb25zZXNbMF0uZGF0YVswXSk7XG4gICAgfSlcbiAgKS50b1Byb21pc2UoKTtcbn1cblxuIl19
